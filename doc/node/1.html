<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用node js 编写前端自动化发布工具 | 周非凡个人博客</title>
    <meta name="description" content="Vue 驱动的静态网站生成器">
    
    
    <link rel="preload" href="/assets/css/0.styles.d01e3fed.css" as="style"><link rel="preload" href="/assets/js/app.c9da9db2.js" as="script"><link rel="preload" href="/assets/js/2.febc0262.js" as="script"><link rel="preload" href="/assets/js/28.8b2856a2.js" as="script"><link rel="prefetch" href="/assets/js/10.0253064e.js"><link rel="prefetch" href="/assets/js/11.175002a3.js"><link rel="prefetch" href="/assets/js/12.c9c2623b.js"><link rel="prefetch" href="/assets/js/13.a252b052.js"><link rel="prefetch" href="/assets/js/14.6a53dc1e.js"><link rel="prefetch" href="/assets/js/15.84088994.js"><link rel="prefetch" href="/assets/js/16.09fbb166.js"><link rel="prefetch" href="/assets/js/17.38b70eaf.js"><link rel="prefetch" href="/assets/js/18.24a31878.js"><link rel="prefetch" href="/assets/js/19.e58abf47.js"><link rel="prefetch" href="/assets/js/20.a4e1f7ec.js"><link rel="prefetch" href="/assets/js/21.520b96e8.js"><link rel="prefetch" href="/assets/js/22.8455ead8.js"><link rel="prefetch" href="/assets/js/23.012b6e4c.js"><link rel="prefetch" href="/assets/js/24.90bca786.js"><link rel="prefetch" href="/assets/js/25.0b9867c9.js"><link rel="prefetch" href="/assets/js/26.5835b50d.js"><link rel="prefetch" href="/assets/js/27.90bf64b9.js"><link rel="prefetch" href="/assets/js/29.4f0f0797.js"><link rel="prefetch" href="/assets/js/3.b8e8b8dc.js"><link rel="prefetch" href="/assets/js/30.ec214258.js"><link rel="prefetch" href="/assets/js/31.19d008c9.js"><link rel="prefetch" href="/assets/js/32.e2e7fb69.js"><link rel="prefetch" href="/assets/js/33.e7250e7c.js"><link rel="prefetch" href="/assets/js/34.6af80751.js"><link rel="prefetch" href="/assets/js/35.8c6fd912.js"><link rel="prefetch" href="/assets/js/36.abacb260.js"><link rel="prefetch" href="/assets/js/37.872fafd6.js"><link rel="prefetch" href="/assets/js/38.c11a6237.js"><link rel="prefetch" href="/assets/js/39.0251e2ab.js"><link rel="prefetch" href="/assets/js/4.a97bd63a.js"><link rel="prefetch" href="/assets/js/40.490030c9.js"><link rel="prefetch" href="/assets/js/41.ae009df1.js"><link rel="prefetch" href="/assets/js/42.733a49d6.js"><link rel="prefetch" href="/assets/js/43.6b0719ec.js"><link rel="prefetch" href="/assets/js/44.8abd3659.js"><link rel="prefetch" href="/assets/js/45.7e9da5d6.js"><link rel="prefetch" href="/assets/js/46.69831b02.js"><link rel="prefetch" href="/assets/js/47.0187e2c6.js"><link rel="prefetch" href="/assets/js/48.d573af72.js"><link rel="prefetch" href="/assets/js/49.c0de9630.js"><link rel="prefetch" href="/assets/js/5.9f3cace6.js"><link rel="prefetch" href="/assets/js/50.dd93629a.js"><link rel="prefetch" href="/assets/js/51.0de94388.js"><link rel="prefetch" href="/assets/js/52.f40156a5.js"><link rel="prefetch" href="/assets/js/53.cd0087a3.js"><link rel="prefetch" href="/assets/js/54.dc27779e.js"><link rel="prefetch" href="/assets/js/55.e83361b5.js"><link rel="prefetch" href="/assets/js/56.e98fbba1.js"><link rel="prefetch" href="/assets/js/57.29f5154b.js"><link rel="prefetch" href="/assets/js/58.2a266b80.js"><link rel="prefetch" href="/assets/js/59.a0a6d426.js"><link rel="prefetch" href="/assets/js/6.ea94c1bd.js"><link rel="prefetch" href="/assets/js/60.431c1ff3.js"><link rel="prefetch" href="/assets/js/61.f3c25606.js"><link rel="prefetch" href="/assets/js/62.df795bbf.js"><link rel="prefetch" href="/assets/js/7.954bbdf7.js"><link rel="prefetch" href="/assets/js/8.5ac09073.js"><link rel="prefetch" href="/assets/js/9.1c3b9112.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d01e3fed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS 专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/css/1.html" class="sidebar-link">css 常用知识点</a></li><li><a href="/doc/css/2.html" class="sidebar-link">清除浮动</a></li><li><a href="/doc/css/3.html" class="sidebar-link">三大经典问题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTML 专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/html/1.html" class="sidebar-link">浏览器解析流程</a></li><li><a href="/doc/html/2.html" class="sidebar-link">viewport原理</a></li><li><a href="/doc/html/3.html" class="sidebar-link">meta标签</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JS 专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/js/1-1.html" class="sidebar-link">堆栈调用（上篇）</a></li><li><a href="/doc/js/1-2.html" class="sidebar-link">堆栈调用（下篇）</a></li><li><a href="/doc/js/2.html" class="sidebar-link">作用域与闭包</a></li><li><a href="/doc/js/3.html" class="sidebar-link">this绑定解析</a></li><li><a href="/doc/js/4-1.html" class="sidebar-link">call、apply原理与使用场景</a></li><li><a href="/doc/js/4-2.html" class="sidebar-link">bind 的原理与使用场景</a></li><li><a href="/doc/js/5-1.html" class="sidebar-link">浅拷贝概念以及实现原理</a></li><li><a href="/doc/js/5-2.html" class="sidebar-link">深拷贝概念以及实现原理</a></li><li><a href="/doc/js/6-1.html" class="sidebar-link">原型与继承之基本概念</a></li><li><a href="/doc/js/6-2.html" class="sidebar-link">原型与继承之（6种继承方案）</a></li><li><a href="/doc/js/7.html" class="sidebar-link">事件机制</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具函数 专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/utils/1.html" class="sidebar-link">常见的JS方法</a></li><li><a href="/doc/utils/2.html" class="sidebar-link">常见的正则表达式</a></li><li><a href="/doc/utils/3.html" class="sidebar-link">常用的时间处理方法</a></li><li><a href="/doc/utils/4.html" class="sidebar-link">常用的金额处理方法</a></li><li><a href="/doc/utils/5.html" class="sidebar-link">继承和原型链demo</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTTP 专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/http/1.html" class="sidebar-link">常见的14种响应状态码</a></li><li><a href="/doc/http/2.html" class="sidebar-link">Http首部字段</a></li><li><a href="/doc/http/3.html" class="sidebar-link">Https介绍</a></li><li><a href="/doc/http/4.html" class="sidebar-link">Web的攻击技术</a></li><li><a href="/doc/http/5.html" class="sidebar-link">Http 发展历史</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue 专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/vue/1.html" class="sidebar-link">Vue 双向绑定的原理</a></li><li><a href="/doc/vue/2.html" class="sidebar-link">Vue 踩坑总结</a></li><li><a href="/doc/vue/3.html" class="sidebar-link">Vue 生命周期详解</a></li><li><a href="/doc/vue/4.html" class="sidebar-link">Vuex 基本用法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Node 专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/node/1.html" class="active sidebar-link">用node撸一个前端自动化发布工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/node/1.html#场景需求" class="sidebar-link">场景需求</a></li><li class="sidebar-sub-header"><a href="/doc/node/1.html#规则以及流程约定" class="sidebar-link">规则以及流程约定</a></li><li class="sidebar-sub-header"><a href="/doc/node/1.html#技术选型" class="sidebar-link">技术选型</a></li><li class="sidebar-sub-header"><a href="/doc/node/1.html#上手开发" class="sidebar-link">上手开发</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>项目总结</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/project/1.html" class="sidebar-link">H5项目总结</a></li><li><a href="/doc/project/2.html" class="sidebar-link">首页优化项目总结</a></li><li><a href="/doc/project/3.html" class="sidebar-link">vue 输入限制</a></li><li><a href="/doc/project/4.html" class="sidebar-link">搜车库项目总结</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用node-js-编写前端自动化发布工具"><a href="#使用node-js-编写前端自动化发布工具" aria-hidden="true" class="header-anchor">#</a> 使用node js 编写前端自动化发布工具</h1> <h2 id="场景需求"><a href="#场景需求" aria-hidden="true" class="header-anchor">#</a> 场景需求</h2> <p>通常情况下项目的周期离不开这些阶段</p> <div class="language- extra-class"><pre class="language-text"><code>Step 1、 本地开发、自测
Step 2、 发布到测试环境进行测试（包括bug 修复以及回归测试） 
Step 3、 发布上线（如果有预发环境，需要之前加一个预发步骤） 
</code></pre></div><p>基本上我们都会用git去管理项目的开发，从项目开始开发到结束必定伴包含git 开发分支的创建以及最终回归合并到master的步骤。我们不走git flow那套流程，太麻烦也没必要。<br>
因此对git 的操作主要就是2步：</p> <div class="language- extra-class"><pre class="language-text"><code>Step 1、 从master上创建开发分支
Step 2、 开发完毕后将开发分支合并回master，当然在合并回master的同时还要打个tag作为备注，方便功能回滚。
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">提示</p> <p>上述的这些步骤比较简单，比较适合中小型项目。如果是涉及到几十个人（前端）同时开发的大项目，还是请慎用。</p></div> <p>既然每次项目的发布流程都是大致一样的，执行的操作也基本是一致的。而程序猿又是一种很奇怪的生物，他们都很懒且很讨厌做重复的事情，说得夸张些就是宁愿做10件不同的事情，也不愿做2件相同的事。<br>
因此针对上述场景，可以自己开发个发布工具，实现项目的自动化发布，分支的自动化创建与合并。</p> <h2 id="规则以及流程约定"><a href="#规则以及流程约定" aria-hidden="true" class="header-anchor">#</a> 规则以及流程约定</h2> <h3 id="开发分支的格式"><a href="#开发分支的格式" aria-hidden="true" class="header-anchor">#</a> 开发分支的格式</h3> <p>比如feature/version(feature/1.0.0），规定分支只能从master上创建，每次创建新的分支版本号都会往上增加(feature/1.0.0 ——&gt; feature/1.0.1)</p> <h3 id="每个项目的打包脚本"><a href="#每个项目的打包脚本" aria-hidden="true" class="header-anchor">#</a> 每个项目的打包脚本</h3> <p><code>npm run build</code></p> <h3 id="tag的格式"><a href="#tag的格式" aria-hidden="true" class="header-anchor">#</a> tag的格式</h3> <p>这里我们统一使用publish/version做为tag的格式</p> <h3 id="每个项目资源放置位置的统一"><a href="#每个项目资源放置位置的统一" aria-hidden="true" class="header-anchor">#</a> 每个项目资源放置位置的统一</h3> <ul><li>本地打包出来的资源目录统一（dist）</li> <li>测试资源放在nginx服务器上</li> <li>上线资源放在阿里云的CDN上</li></ul> <h2 id="技术选型"><a href="#技术选型" aria-hidden="true" class="header-anchor">#</a> 技术选型</h2> <p>前端工程师当然最喜欢用node，而且有一套现成vue-cli工具可供借鉴。
既然选好了主流框架，为保证功能的完善当然还需要添加其他依赖。</p> <ul><li><a href="https://github.com/tj/commander.js/" target="_blank" rel="noopener noreferrer">commander<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 命令行说明工具</li> <li><a href="https://github.com/shelljs/shelljs" target="_blank" rel="noopener noreferrer">shelljs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 可以在node程序中执行shell脚本的库</li> <li><a href="https://github.com/shelljs/shelljs" target="_blank" rel="noopener noreferrer">chalk<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 特色化控制台日志的工具，在控制台显示success和error的效果</li> <li><a href="https://github.com/ali-sdk/ali-oss" target="_blank" rel="noopener noreferrer">ali-oss<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 阿里云开发的,集成oss接口的node库，主要用来把资源文件上传的OSS的CDN上</li></ul> <h2 id="上手开发"><a href="#上手开发" aria-hidden="true" class="header-anchor">#</a> 上手开发</h2> <h3 id="全局命令行配置"><a href="#全局命令行配置" aria-hidden="true" class="header-anchor">#</a> 全局命令行配置</h3> <p>参考vue-cli 做一些配置<br>
1、 package.json 配置入口<br> <img src="http://p2w3pqeze.bkt.clouddn.com/WX20180524-170209.png" alt="image"><br> <img src="http://p2w3pqeze.bkt.clouddn.com/WX20180524-170242.png" alt="image"></p> <p>补充说明： package.json 中配置的key是 &quot;cb-branch&quot;，但在终端我们输入命令行的时候中间的&quot;-&quot;是可以忽略的。</p> <p>2、 编写脚本
cb文件的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//这行代码的作用就是让下面的代码能在node环境中运行</span>
#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

program
  <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token string">'&lt;command&gt; [options]'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'branch'</span><span class="token punctuation">,</span> <span class="token string">'拉取新的daily分支'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'daily'</span><span class="token punctuation">,</span> <span class="token string">'发布资源到日常'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> <span class="token string">'发布资源到线上'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token string">'上传图片'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'delimg'</span><span class="token punctuation">,</span> <span class="token string">'删除图片'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">,</span> <span class="token string">'重启服务器vm'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'proxy'</span><span class="token punctuation">,</span> <span class="token string">'开启代理'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">,</span> <span class="token string">'创建代理链接'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'unlink'</span><span class="token punctuation">,</span> <span class="token string">'删除代理链接'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>3、执行<code>npm link</code> 将命令暴露到全局，这样每个项目都可以使用它了</p> <h3 id="创建开发分支脚本"><a href="#创建开发分支脚本" aria-hidden="true" class="header-anchor">#</a> 创建开发分支脚本</h3> <h4 id="大致流程"><a href="#大致流程" aria-hidden="true" class="header-anchor">#</a> 大致流程</h4> <ul><li>检查当前分支的是否是master且工作空间是干净的</li> <li>使用shelljs 执行&quot;git pull&quot;命令保证是最新的</li> <li>获取当前的版本号（存在package.json的version字段中）</li> <li>检查版本是否以及被占用了，如果是就增加一个版本再检查，否则返回当前版本</li> <li>创建新的开发分支（名字中带上版本号）</li></ul> <h4 id="代码"><a href="#代码" aria-hidden="true" class="header-anchor">#</a> 代码</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'shelljs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">function</span> <span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dirPath <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> packageJSONPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> packageJSON <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>packageJSONPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> packageJSONObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>packageJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> packageJSONObj<span class="token punctuation">.</span>version<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkBranchIsClean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'git status --porcelain'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&quot;git ls-files --other --exclude-standard --directory | egrep -v '/$'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'请先提交当前分支的所有更改'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">addVersion</span><span class="token punctuation">(</span><span class="token parameter">version</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> version<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/([0-9]+.[0-9]+.)([0-9]+)/</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>$<span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">newBranch</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git checkout master`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git pull`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git checkout -b </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git push --set-upstream origin </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkBranchIsExists</span><span class="token punctuation">(</span><span class="token parameter">version</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git branch -a`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>silent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span> <span class="token operator">||</span> 
     shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&quot;git tag&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>silent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkBranchIsClean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git pull`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> version <span class="token operator">=</span> <span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//检查版本是否以及被占用了，如果是就增加一个版本再检查，否则返回当前版本</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">checkBranchIsExists</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        version <span class="token operator">=</span> <span class="token function">addVersion</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//创建新的开发分支</span>
    <span class="token function">newBranch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`daily/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`创建分支成功 当前版本号</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="提交到测试环境的发布脚本"><a href="#提交到测试环境的发布脚本" aria-hidden="true" class="header-anchor">#</a> 提交到测试环境的发布脚本</h3> <h4 id="大致流程-2"><a href="#大致流程-2" aria-hidden="true" class="header-anchor">#</a> 大致流程</h4> <ul><li>检查master 分支是否有更新如果是，要求把master上面的代码合并过来，因为在你开发的过程中你的队友可能以及发布了一个版本。</li> <li>commit本地的代码,再同步远程的代码，如果有必要对会对本地package.json的&quot;version&quot;字段进行矫正，以开发分支名称中的版本号为主。</li> <li>执行&quot;npm run build&quot;操作，对项目进行打包。</li> <li>打包完成后,将资源发布到测试环境。</li></ul> <h4 id="代码-2"><a href="#代码-2" aria-hidden="true" class="header-anchor">#</a> 代码</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'shelljs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getUserHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'win32'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'USERPROFILE'</span> <span class="token punctuation">:</span> <span class="token string">'HOME'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token parameter">packageJSONPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> branch <span class="token operator">=</span> shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'git symbolic-ref --short HEAD'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>silent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> branch<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/daily\/([0-9]+.[0-9]+.[0-9]+)/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> version <span class="token operator">=</span> match <span class="token operator">&amp;&amp;</span> match<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token operator">?</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'分支必须为daily/x.x.x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> version<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getPackageJSON</span><span class="token punctuation">(</span><span class="token parameter">dirPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> packageJSONPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> packageJSON <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>packageJSONPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>packageJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">saveBuildInfoToPackageJSON</span><span class="token punctuation">(</span><span class="token parameter">dirPath<span class="token punctuation">,</span> packageJSON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> packageJSONPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    packageJSON<span class="token punctuation">.</span>version <span class="token operator">=</span> version<span class="token punctuation">;</span>

    <span class="token comment">// TODO: 记录最后一次发布daily的hash, 用来验证是否已经上传了代码</span>
    <span class="token comment">// packageJSON.cbLastDailyCommitHash =</span>
    <span class="token keyword">const</span> packageJSONStr <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>packageJSON<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>packageJSONPath<span class="token punctuation">,</span> packageJSONStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shell<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isDir</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stat</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">removeFiles</span><span class="token punctuation">(</span><span class="token parameter">dirPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> files <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> itemIsDir <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">isDir</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>itemIsDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> <span class="token function">removeFiles</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> isAsset <span class="token operator">=</span> config<span class="token punctuation">.</span>daily<span class="token punctuation">.</span>exts<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">ext</span> <span class="token operator">=&gt;</span> filePath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAsset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">pushBranch</span><span class="token punctuation">(</span><span class="token parameter">packageJSON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'git add .'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git commit -m &quot;日常发布</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git pull origin daily/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git push origin daily/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadFiles</span><span class="token punctuation">(</span><span class="token parameter">srcPath<span class="token punctuation">,</span> packageJSON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cbPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getUserHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.cb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>cbPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`mkdir </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cbPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> repoName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>daily<span class="token punctuation">.</span>repo<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> assetPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cbPath<span class="token punctuation">,</span> repoName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>assetPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`cd </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cbPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &amp;&amp; git clone </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>daily<span class="token punctuation">.</span>repo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> projectPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>assetPath<span class="token punctuation">,</span> packageJSON<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>projectPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`mkdir </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>projectPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> versionPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>projectPath<span class="token punctuation">,</span> packageJSON<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`cd </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>assetPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &amp;&amp; git pull`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>versionPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`cp -r </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>srcPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>versionPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">removeFiles</span><span class="token punctuation">(</span>versionPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`cd </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>assetPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &amp;&amp; git add . &amp;&amp; git commit -m &quot;日常发布</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; &amp;&amp; git push origin master`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">buildScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git pull origin daily/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//这里执行的其实就是&quot;npm run build&quot;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>daily<span class="token punctuation">.</span>build<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token parameter">dirPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> configPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">'cb.config.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>configPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newConfig <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>configPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> newConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getMasterHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hash <span class="token operator">=</span> shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'git log master  --pretty=format:&quot;%H&quot; -1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        silent<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkMasterUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'git fetch origin master:master'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> isUpdate <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git branch --no-merged | grep master`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>silent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`master分支有更新，请先合并master分支到daily/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dirPath <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getConfig</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> srcPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> config<span class="token punctuation">.</span>daily<span class="token punctuation">.</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> packageJSON <span class="token operator">=</span> <span class="token function">getPackageJSON</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkMasterUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">buildScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">uploadFiles</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> packageJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pushBranch</span><span class="token punctuation">(</span>packageJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'日常发布成功!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`访问链接：http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>daily<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="开发完成，项目上线发布脚本"><a href="#开发完成，项目上线发布脚本" aria-hidden="true" class="header-anchor">#</a> 开发完成，项目上线发布脚本</h3> <h4 id="大致流程-3"><a href="#大致流程-3" aria-hidden="true" class="header-anchor">#</a> 大致流程</h4> <ul><li>还是要检查下当前master上是否有更新，如果有就进行合并。</li> <li>将当前的分支合并到master,并打上一个tag。</li> <li>将测试环境测试通过的代码上传到阿里云的CDN上,发布完成。</li></ul> <h4 id="代码-3"><a href="#代码-3" aria-hidden="true" class="header-anchor">#</a> 代码</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">OSS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ali-oss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'shelljs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getPackageJSON</span><span class="token punctuation">(</span><span class="token parameter">dirPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> packageJSONPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> packageJSON <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>packageJSONPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>packageJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    shell<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getFiles</span><span class="token punctuation">(</span><span class="token parameter">parentName<span class="token punctuation">,</span> dirPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> files <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> fileArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> itemIsDir <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">isDir</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>parentName<span class="token punctuation">,</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>itemIsDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fileArr <span class="token operator">=</span> fileArr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getFiles</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      fileArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> fileArr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isDir</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stat</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token parameter">dirPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFiles</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> assets <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> config<span class="token punctuation">.</span>online<span class="token punctuation">.</span>exts<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">ext</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> assets<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> item<span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">uploadAsset</span><span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> asset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>asset<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> client<span class="token punctuation">.</span><span class="token function">putStream</span><span class="token punctuation">(</span>asset<span class="token punctuation">.</span>name<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadAssets</span><span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> assets</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span><span class="token string">'uploading assets'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  spinner<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> assets<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">uploadAsset</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> assets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  spinner<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">addVersion</span><span class="token punctuation">(</span><span class="token parameter">dirPath<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> packageJSON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> version <span class="token operator">=</span> packageJSON<span class="token punctuation">.</span>version<span class="token punctuation">;</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> packageJSON<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  <span class="token keyword">return</span> assets<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    item<span class="token punctuation">.</span>name <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> version<span class="token punctuation">,</span> item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> item<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getUserHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'win32'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'USERPROFILE'</span> <span class="token punctuation">:</span> <span class="token string">'HOME'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">pushTag</span><span class="token punctuation">(</span><span class="token parameter">packageJSON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git tag publish/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git push origin publish/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'git checkout master'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git merge daily/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git push origin :daily/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git pull origin master`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git push origin master`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token parameter">dirPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> configPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">'cb.config.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>configPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newConfig <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>configPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> newConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkMasterUpdate</span><span class="token punctuation">(</span><span class="token parameter">packageJSON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'git fetch origin master:master'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> isUpdate <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`git branch --no-merged | grep master`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>silent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`master分支有更新，请先合并master分支到daily/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n并执行cb daily命令将代码发布到daily`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dirPath <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">getConfig</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    region<span class="token punctuation">:</span> config<span class="token punctuation">.</span>online<span class="token punctuation">.</span>region<span class="token punctuation">,</span>
    accessKeyId<span class="token punctuation">:</span> config<span class="token punctuation">.</span>online<span class="token punctuation">.</span>accessKeyId<span class="token punctuation">,</span>
    accessKeySecret<span class="token punctuation">:</span> config<span class="token punctuation">.</span>online<span class="token punctuation">.</span>accessKeySecret<span class="token punctuation">,</span>
    bucket<span class="token punctuation">:</span> config<span class="token punctuation">.</span>online<span class="token punctuation">.</span>bucket
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> packageJSON <span class="token operator">=</span> <span class="token function">getPackageJSON</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">checkMasterUpdate</span><span class="token punctuation">(</span>packageJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pushTag</span><span class="token punctuation">(</span>packageJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dailyPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getUserHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.cb'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`assets/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> assets <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAssets</span><span class="token punctuation">(</span>dailyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  assets <span class="token operator">=</span> <span class="token function">addVersion</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> packageJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">uploadAssets</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'线上发布成功!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`访问链接：http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>online<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJSON<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="todo"><a href="#todo" aria-hidden="true" class="header-anchor">#</a> Todo</h3> <p><strong>当然这个工具还有一些需要改进的地方</strong></p> <ul><li>在执行cb branch的时候就可以更新掉package.json中的version,不用在后期去做判断再去矫正。</li> <li>发布上线的时候应该是先往OSS上上传资源，如果上传成功，在执行分支的合并与tag的生成。</li> <li>增加回调脚本，为了满足一些特殊的需求，例如在发布上线需要执行额外的一些脚本。</li></ul> <div class="tip custom-block"><p class="custom-block-title">补充说明</p> <p>这里只给出核心代码，完整源码就不暴露了，因为涉及到前公司的一些IP、密钥等隐私问题，还请见谅。</p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/doc/vue/4.html" class="prev">
          Vuex 基本用法
        </a></span> <span class="next"><a href="/doc/project/1.html">
          H5项目总结
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c9da9db2.js" defer></script><script src="/assets/js/2.febc0262.js" defer></script><script src="/assets/js/28.8b2856a2.js" defer></script>
  </body>
</html>
